<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Galactica++ (arrow‑fiender)</title>
  <style>
    body   { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; margin: 0 auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.4.2/lib/addons/p5.sound.min.js"></script>
</head>
<body>
<script>
/*****************************
 *  Global state & constants *
 *****************************/
let player, bullets = [], enemies = [], enemyBullets = [], explosions = [], stars = [];
let level = 1, score = 0, gameOver = false, showStartScreen = true;
let enemyDirection = 1, enemySpeed = 1, enemyShootTimer = 0;
let highscore = 0, tripleShot = false, tripleTimer = 0;

let shotSound, explodeSound;

/******************
 *  Asset loading *
 ******************/
function preload () {
  shotSound   = loadSound('shot.wav');
  explodeSound = loadSound('explode.wav');
}

/*****************
 *  Tiny helpers *
 *****************/
function drawLabel (txt, x, y, size = 16, alignH = LEFT) {
  fill(255); textSize(size); textAlign(alignH, TOP); text(txt, x, y);
}

/*****************
 *  Core classes *
 *****************/
class Particle {
  constructor (x, y) {
    this.pos   = createVector(x, y);
    this.vel   = p5.Vector.random2D().mult(random(1, 4));
    this.alpha = 255;
    this.size  = random(2, 5);
  }
  update () {
    this.pos.add(this.vel);
    this.alpha -= 5;
  }
  draw () {
    noStroke();
    fill(255, 150, 0, this.alpha);
    ellipse(this.pos.x, this.pos.y, this.size);
  }
  isAlive () { return this.alpha > 0; }
}

class Explosion {
  constructor (x, y) {
    this.particles = Array.from({ length: 20 }, () => new Particle(x, y));
  }
  update () {
    this.particles.forEach(p => p.update());
    this.particles = this.particles.filter(p => p.isAlive());
  }
  draw   () { this.particles.forEach(p => p.draw()); }
  isDone () { return this.particles.length === 0; }
}

class Star {
  constructor () {
    this.x = random(width);
    this.y = random(height);
    this.z = random(1, 3);
  }
  update () {
    this.y += this.z;
    if (this.y > height) { this.y = 0; this.x = random(width); }
  }
  draw () {
    noStroke(); fill(255, this.z * 100);
    circle(this.x, this.y, this.z);
  }
}

class Bullet {
  constructor (x, y, speed = 7) { this.x = x; this.y = y; this.r = 4; this.speed = speed; }
  update () { this.y -= this.speed; }
  draw   () { fill(255, 255, 0); ellipse(this.x, this.y, this.r * 2); }
  hits (e) {
    return this.x > e.x && this.x < e.x + e.w && this.y > e.y && this.y < e.y + e.h;
  }
}

class EnemyBullet {
  constructor (x, y) { this.x = x; this.y = y; this.r = 4; this.speed = 4; }
  update () { this.y += this.speed; }
  draw   () { fill(255); ellipse(this.x, this.y, this.r * 2); }
  hits (p) {
    return this.x > p.x && this.x < p.x + p.w && this.y > p.y && this.y < p.y + p.h;
  }
}

/*************************
 * Enemy – én “Arrow”    *
 *************************/
class Enemy {
  constructor (x, y) {
    this.x = x; this.y = y;
    this.w = 40; this.h = 28;
    this.origX = x;
    this.zigzag = (y / 40) % 2 === 0;
  }

  update () {
    if (this.zigzag) {
      this.x = this.origX + sin(frameCount * 0.12) * 20;
    } else {
      this.x += enemyDirection * enemySpeed;
    }
    if (this.x < 0 || this.x + this.w > width) {
      enemyDirection *= -1;
      enemies.forEach(e => e.y += 10);
    }
  }

  draw () {
    push();
    translate(this.x + this.w/2, this.y + this.h/2);

    const flap = sin(frameCount * 0.2) * 4;   // vingeslag

    // røde vinger
    noStroke();
    fill(255, 80, 80);
    triangle(-this.w*0.5, this.h*0.3,
               0,        -this.h*0.45 - flap,
               this.w*0.5, this.h*0.3);

    // mørkere kropp
    rectMode(CENTER);
    fill(120, 20, 20);
    rect(0, this.h*0.05, this.w*0.35, this.h*0.5, 4);

    // motor‑glød
    blendMode(ADD);
    fill(255, 40, 40, 140);
    ellipse(0, this.h*0.4, this.w*0.18, this.h*0.5);
    blendMode(BLEND);

    pop();
  }
}

class Player {
  constructor () {
    this.w = 50; this.h = 20; this.x = width / 2 - this.w / 2; this.y = height - this.h - 10;
    this.speed = 5;
  }
  update () {
    if (keyIsDown(LEFT_ARROW) || keyIsDown(65))  this.x -= this.speed;
    if (keyIsDown(RIGHT_ARROW) || keyIsDown(68)) this.x += this.speed;
    this.x = constrain(this.x, 0, width - this.w);
  }
  draw () { fill(0, 255, 255); rect(this.x, this.y, this.w, this.h, 5); }
  shoot () {
    shotSound.play();
    bullets.push(new Bullet(this.x + this.w / 2, this.y));
    if (tripleShot) {
      bullets.push(new Bullet(this.x + this.w / 2 - 10, this.y));
      bullets.push(new Bullet(this.x + this.w / 2 + 10, this.y));
    }
  }
}

/*****************
 *  Game setup   *
 *****************/
function setup () {
  createCanvas(windowWidth, windowHeight);
  textFont('monospace');
  player = new Player();
  createEnemies();
  stars = Array.from({ length: 100 }, () => new Star());
  highscore = int(localStorage.getItem('galactica_highscore') || 0);
}

/*****************
 *  Main loop    *
 *****************/
function draw () {
  background(0);

  // stjernehimmel
  stars.forEach(s => { s.update(); s.draw(); });

  // eksplosjoner
  explosions.forEach(e => { e.update(); e.draw(); });
  explosions = explosions.filter(e => !e.isDone());

  // UI‑tilstander
  if (showStartScreen) { drawUI('Galactica++', 'Trykk mellomrom for å starte'); return; }
  if (gameOver)       { drawUI('GAME OVER', 'Trykk mellomrom for å prøve igjen'); return; }

  // spillobjekter
  player.update(); player.draw();

  bullets.forEach(b => { b.update(); b.draw(); });
  enemyBullets.forEach(b => { b.update(); b.draw(); });
  enemies.forEach(e => { e.update(); e.draw(); });

  // power‑up – triple‑shot
  if (tripleShot && --tripleTimer <= 0) tripleShot = false;

  // kollisjoner & opprydding
  checkCollisions();
  bullets       = bullets.filter(b => b.y > 0);
  enemyBullets  = enemyBullets.filter(b => b.y < height);

  // HUD
  drawLabel(`Poeng: ${score}`, 10, 10);
  drawLabel(`Nivå:  ${level}`, 10, 30);
  drawLabel(`Highscore: ${highscore}`, 10, 50);
  if (tripleShot) drawLabel('POWER‑UP: TRIPLE SHOT', width - 250, 10);

  // fiender skyter
  if (++enemyShootTimer > 60) { enemyShoot(); enemyShootTimer = 0; }

  // nivå fullført?
  if (enemies.length === 0) { level++; enemySpeed = min(1 + level * 0.3, 3); createEnemies(); }
}

function keyPressed () {
  if (key === ' ') {
    if (showStartScreen)      showStartScreen = false;
    else if (gameOver)        resetGame();
    else                      player.shoot();
  }
}

function resetGame () {
  if (score > highscore) localStorage.setItem('galactica_highscore', score);
  level = 1; score = 0; enemySpeed = 1;
  bullets = []; enemyBullets = []; explosions = [];
  player = new Player(); createEnemies(); gameOver = false;
}

function drawUI (title, subtitle) {
  fill(255); textAlign(CENTER, CENTER);
  textSize(40); text(title, width / 2, height / 2 - 40);
  textSize(20); text(subtitle, width / 2, height / 2);
}

function createEnemies () {
  enemies = [];
  const rows = 3 + floor(level / 2),
        cols = 5 + level;
  for (let i = 0; i < rows; i++) {
    for (let j = 0; j < cols; j++) {
      const x = 60 + j * 60;
      const y = 60 + i * 40;
      enemies.push(new Enemy(x, y));
    }
  }
}

function enemyShoot () {
  if (!enemies.length) return;
  const e = random(enemies);
  enemyBullets.push(new EnemyBullet(e.x + e.w / 2, e.y + e.h));
}

function checkCollisions () {
  // spiller‑kuler → fiender
  for (let i = bullets.length - 1; i >= 0; i--) {
    const b = bullets[i];
    for (let j = enemies.length - 1; j >= 0; j--) {
      const e = enemies[j];
      if (b.hits(e)) {
        bullets.splice(i, 1); enemies.splice(j, 1);
        explosions.push(new Explosion(e.x + e.w / 2, e.y + e.h / 2));
        score += 10; explodeSound.play();
        if (random() < 0.05) activateTripleShot();
        break;
      }
    }
  }
  // fiende‑kuler → spiller
  for (const b of enemyBullets) if (b.hits(player)) { gameOver = true; explodeSound.play(); }
}

function activateTripleShot () { tripleShot = true; tripleTimer = 300; }

function windowResized () { resizeCanvas(windowWidth, windowHeight); }
</script>
</body>
</html>